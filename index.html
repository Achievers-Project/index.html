<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>RBI Game</title>
<style>
  :root{
    --bg:#0f1113; --card:#141516; --muted:#9aa0a6; --text:#e8eef2;
    --accent-1:#6a5acd; --accent-2:#8b5cf6;
    --btn-start:#7b61ff; --btn-end:#5ad0ff;
  }
  *{box-sizing:border-box}
  body{font-family:Inter,Arial,Helvetica,sans-serif;margin:0;padding:0;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
  .container{max-width:980px;margin:18px auto;padding:18px;background:var(--card);border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.6)}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
  h1{margin:0;font-size:20px}
  .controls{display:flex;gap:10px;align-items:center}
  .stats{display:flex;flex-wrap:wrap;gap:8px;justify-content:space-around;margin-bottom:12px}
  .stat{background:rgba(255,255,255,0.03);padding:8px 10px;border-radius:8px;font-weight:700;font-size:13px;min-width:140px;text-align:center}
  .graphContainer{margin:12px 0}
  .graphBar{height:22px;margin:6px 0;border-radius:10px;padding:2px 10px;color:#fff;display:flex;align-items:center;font-weight:700;box-sizing:border-box;overflow:hidden}
  .economyBar{background:linear-gradient(90deg,var(--accent-1),var(--accent-2))}
  .bankBar{background:linear-gradient(90deg,#35d46a,#3af285)}
  .publicBar{background:linear-gradient(90deg,#ff5c5c,#ff8a8a)}
  .inflationBar{background:linear-gradient(90deg,#ffbf00,#ffd95a);color:#111}
  .liquidityBar{background:linear-gradient(90deg,#00bfff,#6fe3ff)}
  .eventBox{background:#171717;padding:14px;border-radius:10px;min-height:150px;margin-bottom:12px;transition:all .2s}
  .eventTitle{font-weight:900;margin-bottom:6px}
  #buttonsArea{display:flex;flex-direction:column;gap:10px;margin-top:10px}
  .row-btn{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02);cursor:pointer;font-weight:800}
  .row-btn:hover{background:rgba(255,255,255,0.03)}
  button.btn{padding:8px 12px;border-radius:8px;border:0;background:linear-gradient(90deg,var(--btn-start),var(--btn-end));cursor:pointer;color:#04111a;font-weight:800}
  #timer{font-weight:800;text-align:center;margin-bottom:8px}
  footer{margin-top:12px;font-size:13px;color:var(--muted);display:flex;justify-content:space-between;align-items:center}
  #hariRapContainer{margin-top:10px;padding:12px;background:#2f0000;border-radius:8px;color:#fff;max-height:0;overflow:hidden;transition:max-height .35s, opacity .25s;opacity:0}
  #vfxCanvas{position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:9999}
  @media (max-width:720px){ .stats{justify-content:space-between} .container{margin:8px} }
</style>
</head>
<body>
  <canvas id="vfxCanvas" aria-hidden="true"></canvas>

  <div style="text-align:center;margin:12px 0">
    <img src="https://images.seeklogo.com/logo-png/16/1/rbi-logo-png_seeklogo-168562.png" alt="RBI" width="120">
  </div>

  <div class="container" role="main">
    <header>
      <h1 id="title">RBI Game</h1>
      <div class="controls">
        <label><input type="checkbox" id="themeToggle"> Light</label>
        <button id="openLeaderboardBtn" class="btn">Leaderboard</button>
        <div id="monthDisplay" style="font-weight:900">Month: 1 / 12</div>
      </div>
    </header>

    <div class="stats" aria-live="polite">
      <div class="stat">Economy: <span id="economy">50</span></div>
      <div class="stat">Bank Health: <span id="bank">50</span></div>
      <div class="stat">Public: <span id="public">50</span></div>
      <div class="stat">Inflation: <span id="inflation">5%</span></div>
      <div class="stat">Liquidity: <span id="liquidity">50</span></div>
    </div>

    <div id="graphArea" class="graphContainer"></div>
    <div id="timer">Time Left: <span id="timeNum">30</span>s</div>

    <div id="eventArea" class="eventBox" aria-live="assertive">
      <div class="eventTitle" id="eventTitle">Welcome</div>
      <div id="eventText">The RBI Quiz â€” answer questions and manage policy.</div>
      <div id="eventSub"></div>
      <div id="miniArea"></div>
    </div>

    <div id="buttonsArea" role="group" aria-label="choices"></div>
    <div id="messageArea" aria-live="polite" style="min-height:20px;margin-top:6px;color:var(--muted)"></div>

    <footer>
      <span>Made by Syed / RBIÂ©2025</span>
      <div><button id="footerDontBtn" class="btn">Don't click</button></div>
    </footer>

    <div id="hariRapContainer" aria-hidden="true">
Yo Hari, always missing in the grind,
We code all night, you lag behind.
Ideas flowing, you just chill,
While we debug, you spill.
Step up now, face the heat,
Or watch your defeat repeat.
    </div>
  </div>

  <!-- Leaderboard modal (simple) -->
  <aside id="leaderboardModal" aria-hidden="true" style="position:fixed;right:14px;top:14px;width:340px;background:#0b0b0c;padding:12px;border-radius:10px;box-shadow:0 12px 40px rgba(0,0,0,.6);display:none;z-index:999">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <strong>Leaderboard</strong>
      <div style="display:flex;gap:6px">
        <button id="closeLeaderboardBtn" class="btn">Close</button>
      </div>
    </div>
    <div id="leaderboardList" style="max-height:320px;overflow:auto;margin-bottom:8px"></div>
    <div style="display:flex;gap:8px">
      <input id="lbNameInput" placeholder="Your name" style="flex:1;padding:8px;border-radius:8px;border:1px solid #222;background:transparent;color:var(--text)">
      <button id="submitScoreBtn" class="btn">Submit</button>
    </div>
    <div style="margin-top:8px;color:var(--muted)">pls type ur name and saved locally in ur browser to flex to other coons</div>
  </aside>

<script>
/* Clean, corrected single-file implementation
   - Fixed: question sequencing (12 unique per session, random each session)
   - Fixed: buttons/handlers, timers, mini-games (only liquidity & setRate)
   - VFX: pick exactly 1 VFX from 4 types each action (fire, lightning, sparks, coins)
   - When mini-game triggers, question UI is cleared; questions resume afterwards
   - Title kept as "RBI Game"
   - Defensive and linear code flow to avoid previous scoping/duplication bugs
*/

document.addEventListener('DOMContentLoaded', () => {
  // ---------- State ----------
  let economy = 50, bank = 50, publicHappiness = 50, inflation = 5, liquidity = 50;
  let month = 1, maxMonth = 12;
  let timer = null, timeLeft = 30;
  let sessionQuestions = [];      // array of 12 MCQs for this game
  let sessionIndex = 0;           // which MCQ is next
  let inMiniGame = false;

  const PREV_SESSION_KEY = 'rbi_prev_session_v5';
  const LB_KEY = 'rbi_leaderboard_v5';

  // ---------- DOM refs ----------
  const economyEl = document.getElementById('economy');
  const bankEl = document.getElementById('bank');
  const publicEl = document.getElementById('public');
  const inflationEl = document.getElementById('inflation');
  const liquidityEl = document.getElementById('liquidity');
  const monthDisplay = document.getElementById('monthDisplay');
  const graphArea = document.getElementById('graphArea');
  const eventTitle = document.getElementById('eventTitle');
  const eventText = document.getElementById('eventText');
  const eventSub = document.getElementById('eventSub');
  const miniArea = document.getElementById('miniArea');
  const buttonsArea = document.getElementById('buttonsArea');
  const messageArea = document.getElementById('messageArea');
  const timeNum = document.getElementById('timeNum');
  const vfxCanvas = document.getElementById('vfxCanvas');
  const ctx = vfxCanvas.getContext('2d');

  const openLeaderboardBtn = document.getElementById('openLeaderboardBtn');
  const leaderboardModal = document.getElementById('leaderboardModal');
  const closeLeaderboardBtn = document.getElementById('closeLeaderboardBtn');
  const leaderboardList = document.getElementById('leaderboardList');
  const submitScoreBtn = document.getElementById('submitScoreBtn');
  const lbNameInput = document.getElementById('lbNameInput');

  const footerDontBtn = document.getElementById('footerDontBtn');
  const hariRap = document.getElementById('hariRapContainer');

  // ---------- MCQ pool (20) ----------
  const mcqPool = [
    { id:1, text:"What is RBI's primary tool to control inflation?", options:[
        {text:"Open Market Operations", econ:+1, bank:+1, infl:-2},
        {text:"Fiscal stimulus by government", econ:+2, infl:+2},
        {text:"Currency devaluation", econ:-2, infl:+3}
      ]},
    { id:2, text:"If inflation rises, RBI most likely will:", options:[
        {text:"Increase policy rates", econ:-3, bank:+3, infl:-3},
        {text:"Reduce reserve requirements", econ:+2, infl:+1},
        {text:"Increase public spending", econ:+3, infl:+2}
      ]},
    { id:3, text:"Liquidity injection usually:", options:[
        {text:"Increases liquidity & eases credit", econ:+2, bank:+2, liq:+6},
        {text:"Decreases public happiness", pub:-2},
        {text:"Immediately cuts inflation", infl:-3}
      ]},
    { id:4, text:"Open Market Operations are:", options:[
        {text:"Buying/selling government securities", econ:+1, bank:+2, liq:+4},
        {text:"Printing currency arbitrarily", infl:+4},
        {text:"Changing income tax rates", econ:0}
      ]},
    { id:5, text:"RBI raising repo rate typically:", options:[
        {text:"Discourages borrowing", econ:-2, bank:+2, infl:-2},
        {text:"Increases liquidity", liq:+6},
        {text:"Has no effect on banks", bank:0}
      ]},
    { id:6, text:"Which improves bank health most directly?", options:[
        {text:"Stricter audits & capital requirements", bank:+4, econ:-1},
        {text:"Lowering interest rates", bank:-2},
        {text:"Cutting bank staff", bank:-1}
      ]},
    { id:7, text:"How to boost public happiness short term?", options:[
        {text:"Targeted subsidies", econ:-2, pub:+4, liq:-2},
        {text:"Tighten monetary policy", pub:-2},
        {text:"Ignore public complaints", pub:-6}
      ]},
    { id:8, text:"Liquidity trap means:", options:[
        {text:"Monetary policy loses potency", econ:-2},
        {text:"Banks refuse deposits", bank:-3},
        {text:"Negative inflation", infl:-2}
      ]},
    { id:9, text:"Sterilisation is:", options:[
        {text:"Offsetting liquidity impact of capital flows", bank:+1},
        {text:"Printing more currency", infl:+3},
        {text:"Banning foreign investment", econ:-2}
      ]},
    { id:10, text:"What reduces inflation without hurting growth?", options:[
        {text:"Careful rate increases + communication", infl:-2, pub:+1},
        {text:"Large sudden hikes", econ:-3},
        {text:"Freeze on lending", econ:-4}
      ]},
    { id:11, text:"Foreign investment surge can:", options:[
        {text:"Boost economy & liquidity", econ:+4, liq:+4},
        {text:"Always hurt public happiness", pub:-2},
        {text:"Cause banking collapse", bank:-5}
      ]},
    { id:12, text:"Which helps digital payments uptake?", options:[
        {text:"Invest in infrastructure", econ:+3, pub:+4, liq:-2},
        {text:"Ignore the demand", pub:-4},
        {text:"Ban digital wallets", pub:-5}
      ]},
    { id:13, text:"Forward guidance means:", options:[
        {text:"Communicating future policy intent", pub:+1, econ:+1},
        {text:"Secret rate decisions", pub:-2},
        {text:"Immediate fiscal transfers", econ:+2}
      ]},
    { id:14, text:"If banks report fraud, best action:", options:[
        {text:"Aggressive audits & fines", bank:+4, pub:+2},
        {text:"Cover it up", bank:-6, pub:-4},
        {text:"Ignore", pub:-5}
      ]},
    { id:15, text:"What lowers inflation expectations?", options:[
        {text:"Credible policy + communication", infl:-2, pub:+1},
        {text:"Hoarding cash", econ:-1},
        {text:"Cutting wages", pub:-2}
      ]},
    { id:16, text:"Why maintain buffer liquidity?", options:[
        {text:"Handle shocks & stabilize markets", bank:+3, liq:+5},
        {text:"Slow economy", econ:-2},
        {text:"Increase corruption", pub:-3}
      ]},
    { id:17, text:"Which encourages exports?", options:[
        {text:"Targeted export loans", econ:+3, bank:-2, liq:-3},
        {text:"High export taxes", econ:-3},
        {text:"Close borders", econ:-5}
      ]},
    { id:18, text:"Cybersecurity attack on payments requires:", options:[
        {text:"Invest in security quickly", bank:+3, pub:+2, liq:-4},
        {text:"Ignore minor breaches", bank:-2, pub:-3},
        {text:"Publicly share all data", pub:-5}
      ]},
    { id:19, text:"Inflation measure RBI watches:", options:[
        {text:"Consumer Price Index (CPI)", infl:0},
        {text:"Number of bank branches", bank:0},
        {text:"Stock market returns", econ:0}
      ]},
    { id:20, text:"What is quantitative easing?", options:[
        {text:"Large scale asset purchases", liq:+10, infl:+2},
        {text:"Banning lending", econ:-3},
        {text:"Printing money & transfer", pub:+1, infl:+4}
      ]}
  ];

  // ---------- Session selection (pick 12 unique random) ----------
  function pickSessionQuestions(){
    const ids = mcqPool.map(q => q.id);
    // shuffle
    for(let i=ids.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [ids[i],ids[j]]=[ids[j],ids[i]]; }
    const pickIds = ids.slice(0,12);
    // store pick to localStorage to try avoiding immediate repeats next game (optional)
    localStorage.setItem(PREV_SESSION_KEY, JSON.stringify(pickIds));
    return pickIds.map(id => mcqPool.find(q => q.id === id));
  }

  // ---------- VFX (pick exactly 1 each time) ----------
  // Canvas setup
  let DPR = window.devicePixelRatio || 1;
  function resizeCanvas(){ DPR = window.devicePixelRatio || 1; vfxCanvas.width = innerWidth * DPR; vfxCanvas.height = innerHeight * DPR; vfxCanvas.style.width = innerWidth + 'px'; vfxCanvas.style.height = innerHeight + 'px'; ctx.setTransform(DPR,0,0,DPR,0,0); }
  window.addEventListener('resize', resizeCanvas);
  resizeCanvas();

  const fireParts = [], lightningBolts = [], sparks = [];

  function spawnFire(x,y,count=18){
    for(let i=0;i<count;i++){
      fireParts.push({
        x: x + (Math.random()-0.5)*20,
        y: y + (Math.random()-0.5)*10,
        vx: (Math.random()-0.5)*1.6, vy: - (1 + Math.random()*3),
        size: 6 + Math.random()*12, life:40 + Math.round(Math.random()*40)
      });
    }
  }
  function spawnLightning(x,y,count=1){
    for(let i=0;i<count;i++) lightningBolts.push({x,y,segments:[],life:14,thickness:2 + Math.random()*3});
  }
  function spawnSparks(x,y,count=12){
    for(let i=0;i<count;i++) sparks.push({
      x: x + (Math.random()-0.5)*30, y: y + (Math.random()-0.5)*20,
      vx:(Math.random()-0.5)*4, vy: - (Math.random()*4+1), size:2 + Math.random()*6, life:30 + Math.round(Math.random()*40),
      color: ['#fff4aa','#ffd59f','#bfe9ff'][Math.floor(Math.random()*3)]
    });
  }
  function spawnCoinStreamDOM(x,y,count=10){
    for(let i=0;i<count;i++){
      const el = document.createElement('div');
      el.textContent='â‚¹';
      el.style.position='fixed'; el.style.left = (x + (Math.random()-0.5)*40)+'px'; el.style.top=(y + (Math.random()-0.5)*20)+'px';
      el.style.fontSize = (12 + Math.round(Math.random()*18)) + 'px';
      el.style.zIndex = 99999; el.style.pointerEvents = 'none'; el.style.opacity = '1'; el.style.transition = 'transform 1s, opacity 1s';
      document.body.appendChild(el);
      requestAnimationFrame(()=> { el.style.transform = `translate3d(${(Math.random()-0.5)*200}px,${-120 - Math.random()*260}px,0) rotate(${Math.random()*360}deg)`; el.style.opacity='0'; });
      setTimeout(()=> el.remove(),1100);
    }
  }

  // play single VFX chosen randomly from set appropriate to 'kind'
  function playSingleVfx(x,y, kind='neutral'){
    const choices = {
      positive: [ ()=>spawnFire(x,y,20), ()=>spawnSparks(x,y,14), ()=>spawnCoinStreamDOM(x,y,12), ()=>spawnLightning(x,y,1) ],
      neutral:  [ ()=>spawnSparks(x,y,8), ()=>spawnCoinStreamDOM(x,y,6), ()=>spawnSparks(x,y,10) ],
      negative: [ ()=>spawnLightning(x,y,1), ()=>spawnSparks(x,y,12), ()=>spawnFire(x,y,10) ]
    }[kind] || [ ()=>spawnSparks(x,y,8) ];
    const fn = choices[Math.floor(Math.random()*choices.length)];
    try{ fn(); } catch(e){ console.error(e); }
  }

  // canvas animation loop
  let lastTs = performance.now();
  function vfxFrame(ts){
    const dt = ts - lastTs; lastTs = ts;
    ctx.clearRect(0,0,innerWidth,innerHeight);

    for(let i=fireParts.length-1;i>=0;i--){
      const p = fireParts[i]; p.vy += 0.06; p.x += p.vx; p.y += p.vy; p.life--;
      const t = Math.max(0,p.life/80);
      const grad = ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,p.size*1.5);
      grad.addColorStop(0, 'rgba(255,200,60,0.9)'); grad.addColorStop(0.5,'rgba(255,90,40,0.6)'); grad.addColorStop(1,'rgba(0,0,0,0)');
      ctx.fillStyle = grad; ctx.beginPath(); ctx.arc(p.x,p.y,Math.max(1,p.size*t),0,Math.PI*2); ctx.fill();
      if(p.life<=0) fireParts.splice(i,1);
    }
    for(let i=lightningBolts.length-1;i>=0;i--){
      const b = lightningBolts[i];
      if(!b.segments || b.segments.length===0){
        const segs=[]; let cx=b.x, cy=b.y; const len=4 + Math.floor(Math.random()*6);
        for(let s=0;s<len;s++){ const nx = cx + (Math.random()-0.5)*80; const ny = cy + 60 + Math.random()*80; segs.push({x1:cx,y1:cy,x2:nx,y2:ny}); cx=nx; cy=ny; if(cy>innerHeight-20) break; }
        b.segments=segs;
      }
      ctx.lineWidth = b.thickness; const a = b.life/16;
      ctx.strokeStyle = `rgba(200,240,255,${0.9*a})`; ctx.beginPath();
      for(const s of b.segments){ ctx.moveTo(s.x1,s.y1); ctx.lineTo(s.x2,s.y2); } ctx.stroke();
      b.life--; if(b.life<=0) lightningBolts.splice(i,1);
    }
    for(let i=sparks.length-1;i>=0;i--){
      const s = sparks[i]; s.vy += 0.12; s.x += s.vx; s.y += s.vy; s.life--;
      ctx.fillStyle = s.color; ctx.beginPath(); ctx.arc(s.x,s.y,s.size,0,Math.PI*2); ctx.fill();
      if(s.life<=0) sparks.splice(i,1);
    }

    requestAnimationFrame(vfxFrame);
  }
  requestAnimationFrame(vfxFrame);

  // ---------- Utility & UI ----------
  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
  function setMessage(txt){ messageArea.textContent = txt || ''; }
  function updateStats(){ economyEl.textContent = economy; bankEl.textContent = bank; publicEl.textContent = publicHappiness; inflationEl.textContent = inflation + '%'; liquidityEl.textContent = liquidity; monthDisplay.textContent = `Month: ${clamp(month,1,maxMonth)} / ${maxMonth}`; updateGraph(); }
  function updateGraph(){ const inflW = clamp(inflation*4,0,100); graphArea.innerHTML = `
    <div class="graphBar economyBar" style="width:${economy}%">Economy: ${economy}</div>
    <div class="graphBar bankBar" style="width:${bank}%">Bank Health: ${bank}</div>
    <div class="graphBar publicBar" style="width:${publicHappiness}%">Public: ${publicHappiness}</div>
    <div class="graphBar inflationBar" style="width:${inflW}%">Inflation: ${inflation}%</div>
    <div class="graphBar liquidityBar" style="width:${liquidity}%">Liquidity: ${liquidity}</div>`; }

  // ---------- Timer ----------
  function startTimer(seconds=30){
    clearTimer(); timeLeft = seconds; timeNum.textContent = timeLeft;
    timer = setInterval(()=>{ timeLeft--; timeNum.textContent = timeLeft; if(timeLeft <= 0){ clearTimer(); setMessage("Time's up â€” default applied."); onTimeout(); } },1000);
  }
  function clearTimer(){ if(timer){ clearInterval(timer); timer = null; } }

  // ---------- Session/questions ----------
  sessionQuestions = pickSessionQuestions(); sessionIndex = 0;

  function presentMCQ(){
    inMiniGame = false;
    miniArea.innerHTML = '';
    buttonsArea.innerHTML = '';
    if(sessionIndex >= sessionQuestions.length){ gameOver(); return; }
    const q = sessionQuestions[sessionIndex];
    eventTitle.textContent = `Month ${month}`;
    eventText.textContent = q.text;
    eventSub.textContent = `Question ${sessionIndex+1} / ${sessionQuestions.length}`;
    q.options.forEach(opt=>{
      const row = document.createElement('div'); row.className='row-btn';
      const label = document.createElement('div'); label.textContent = opt.text;
      row.appendChild(label);
      row.addEventListener('click', (ev)=>{
        clearTimer();
        // apply
        economy = clamp(economy + (opt.econ||0),0,100);
        bank = clamp(bank + (opt.bank||0),0,100);
        publicHappiness = clamp(publicHappiness + (opt.pub||opt.public||0),0,100);
        inflation = clamp(inflation + (opt.infl||0),0,20);
        liquidity = clamp(liquidity + (opt.liq||0),0,100);
        updateStats();
        setMessage(`You chose: ${opt.text}`);
        playSingleVfx(ev.clientX || window.innerWidth/2, ev.clientY || window.innerHeight/2, 'positive');
        sessionIndex++;
        month++;
        setTimeout(()=> scheduleNext(), 600);
      });
      buttonsArea.appendChild(row);
    });
    startTimer(30);
  }

  function onTimeout(){
    // default: pick first option if available
    if(!inMiniGame && sessionIndex < sessionQuestions.length){
      const q = sessionQuestions[sessionIndex];
      const opt = q.options[0];
      if(opt){
        economy = clamp(economy + (opt.econ||0),0,100);
        bank = clamp(bank + (opt.bank||0),0,100);
        publicHappiness = clamp(publicHappiness + (opt.pub||opt.public||0),0,100);
        inflation = clamp(inflation + (opt.infl||0),0,20);
        liquidity = clamp(liquidity + (opt.liq||0),0,100);
        updateStats();
        setMessage('Default option applied.');
        playSingleVfx(window.innerWidth/2, eventArea.getBoundingClientRect().top+40, 'neutral');
        sessionIndex++; month++;
        setTimeout(()=> scheduleNext(), 600);
        return;
      }
    }
    // if in mini game simply end and resume
    setTimeout(()=> scheduleNext(), 400);
  }

  // ---------- Scheduling ----------
  function scheduleNext(){
    clearTimer();
    // check end
    if(sessionIndex >= sessionQuestions.length){ gameOver(); return; }
    if(economy <= 0 || bank <= 0 || publicHappiness <= 0){ gameOver(); return; }
    updateStats();
    // 38% chance mini-game
    if(Math.random() < 0.38){
      startMiniGame();
    } else {
      presentMCQ();
    }
  }

  // ---------- Mini-games (liquidity & setRate) ----------
  function startMiniGame(){
    inMiniGame = true;
    clearTimer();
    buttonsArea.innerHTML = '';
    miniArea.innerHTML = '';
    eventText.textContent = 'Mini-Game';
    eventSub.textContent = '';
    // 70% liquidity, 30% setRate
    if(Math.random() < 0.7) renderLiquidityMini();
    else renderSliderMini();
  }

  function renderLiquidityMini(){
    miniArea.innerHTML = '';
    eventText.textContent = 'Allocate emergency liquidity (drag coins)';
    const coinsRow = document.createElement('div');
    for(let i=0;i<6;i++){
      const c = document.createElement('span'); c.textContent='ðŸ’°'; c.style.fontSize='26px'; c.style.margin='6px'; c.style.cursor='grab'; c.draggable=true;
      c.addEventListener('dragstart', e => e.dataTransfer.setData('text/plain','1'));
      coinsRow.appendChild(c);
    }
    const drop = document.createElement('div'); drop.textContent='ðŸ¦ Drop here'; drop.style.marginTop='12px'; drop.style.padding='12px'; drop.style.border='2px dashed rgba(255,255,255,0.06)'; drop.style.borderRadius='8px';
    drop.addEventListener('dragover', e => e.preventDefault());
    drop.addEventListener('drop', e => {
      e.preventDefault();
      const v = parseInt(e.dataTransfer.getData('text/plain')||'1',10);
      liquidity = clamp(liquidity + 5 * v,0,100);
      updateStats();
      setMessage('Liquidity allocated!');
      const rect = drop.getBoundingClientRect();
      playSingleVfx(rect.left + rect.width/2, rect.top + rect.height/2, 'positive');
      const first = coinsRow.querySelector('span'); if(first) first.remove();
      if(!coinsRow.querySelector('span')){ inMiniGame=false; setTimeout(()=> scheduleNext(), 700); }
    });
    miniArea.appendChild(coinsRow); miniArea.appendChild(drop);
    startTimer(25);
  }

  function renderSliderMini(){
    miniArea.innerHTML=''; eventText.textContent='Set policy interest rate';
    const input = document.createElement('input'); input.type='range'; input.min=0; input.max=12; input.value = Math.round(inflation); input.style.width='90%';
    const label = document.createElement('div'); label.textContent = `Selected: ${input.value}%`; label.style.marginTop='8px';
    input.addEventListener('input', ()=> label.textContent = `Selected: ${input.value}%`);
    const setBtn = document.createElement('button'); setBtn.className='btn'; setBtn.textContent='Set Rate';
    setBtn.addEventListener('click', (ev)=>{
      inflation = clamp(Math.round(Number(input.value)),0,20);
      updateStats(); setMessage(`Interest set to ${inflation}%`); playSingleVfx(ev.clientX || window.innerWidth/2, ev.clientY || 0, 'positive');
      inMiniGame=false; setTimeout(()=> scheduleNext(), 700);
    });
    miniArea.appendChild(input); miniArea.appendChild(label); miniArea.appendChild(setBtn);
    startTimer(25);
  }

  // ---------- Game over & restart ----------
  function computeScore(){ const base = month * 120; const statSum = economy + bank + publicHappiness + liquidity; const penalty = inflation * 6; return Math.max(0, Math.round(base + statSum - penalty)); }

  function gameOver(){
    clearTimer();
    buttonsArea.innerHTML=''; miniArea.innerHTML='';
    const restartBtn = document.createElement('button'); restartBtn.className='btn'; restartBtn.textContent='Restart Game'; restartBtn.addEventListener('click', restartGame);
    const submitBtn = document.createElement('button'); submitBtn.className='btn'; submitBtn.textContent='Submit Score'; submitBtn.addEventListener('click', ()=> openLeaderboardAndFill(computeScore()));
    buttonsArea.appendChild(restartBtn); buttonsArea.appendChild(submitBtn);
    if(economy>70 && bank>60 && publicHappiness>60) setMessage('Legendary Governor! You win! Good Game.');
    else if(economy<50 && bank<50) setMessage('You are not fit to be an RBI Governor ðŸ¥²');
    else setMessage('Game over â€” check stats and try again.');
    eventTitle.textContent = 'Nice try';
    const rect = eventTitle.getBoundingClientRect();
    playSingleVfx(rect.left + rect.width/2, rect.top + 20, 'positive');
  }

  function restartGame(){
    clearTimer();
    sessionQuestions = pickSessionQuestions(); sessionIndex = 0;
    economy = 50; bank = 50; publicHappiness = 50; inflation = 5; liquidity = 50;
    month = 1; inMiniGame = false;
    setMessage(''); updateStats();
    setTimeout(()=> presentMCQ(), 350);
  }

  // ---------- Leaderboard ----------
  function loadLeaderboard(){ try{ const raw = localStorage.getItem(LB_KEY); return raw?JSON.parse(raw):[] } catch(e){ return []; } }
  function saveLeaderboard(arr){ try{ localStorage.setItem(LB_KEY, JSON.stringify(arr)); } catch(e){} }
  function addScore(name,score){ const arr = loadLeaderboard(); arr.push({name:(name||'Anonymous').slice(0,30),score:Number(score||0),date:new Date().toISOString()}); arr.sort((a,b)=>b.score-a.score); saveLeaderboard(arr.slice(0,50)); renderLeaderboard(); }
  function renderLeaderboard(){ const arr = loadLeaderboard(); leaderboardList.innerHTML=''; if(arr.length===0){ const n=document.createElement('div'); n.textContent='pls type ur name and saved locally in ur browser to flex to other coons'; n.style.color=getComputedStyle(document.body).getPropertyValue('--muted'); leaderboardList.appendChild(n); return; } arr.forEach((e,i)=>{ const row=document.createElement('div'); row.className='lb-entry'; row.innerHTML=`<div>${i+1}. ${escapeHtml(e.name)}</div><div style="font-weight:900">${e.score}</div>`; leaderboardList.appendChild(row); }); }
  function openLeaderboardAndFill(score){ leaderboardModal.style.display='block'; renderLeaderboard(); lbNameInput.value=''; lbNameInput.dataset.autofill = score; lbNameInput.focus(); }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  // ---------- UI Hooks ----------
  openLeaderboardBtn.addEventListener('click', ()=> openLeaderboardAndFill(computeScore()));
  closeLeaderboardBtn.addEventListener('click', ()=> { leaderboardModal.style.display='none'; });
  submitScoreBtn.addEventListener('click', ()=> {
    const name = lbNameInput.value.trim() || 'Anonymous';
    const score = Number(lbNameInput.dataset.autofill || computeScore());
    addScore(name, score);
    lbNameInput.value=''; lbNameInput.dataset.autofill='';
    setMessage('Score submitted!');
    const r = submitScoreBtn.getBoundingClientRect();
    playSingleVfx(r.left + r.width/2, r.top + r.height/2, 'positive');
  });
  document.getElementById('footerDontBtn').addEventListener('click', (e)=> {
    const r = e.currentTarget.getBoundingClientRect();
    const x = e.clientX || r.left + r.width/2, y = r.top + r.height/2;
    playSingleVfx(x,y,'positive');
    const open = hariRap.style.opacity === '1';
    if(open){ hariRap.style.maxHeight='0'; hariRap.style.opacity='0'; } else { hariRap.style.maxHeight='420px'; hariRap.style.opacity='1'; }
  });

  document.getElementById('themeToggle').addEventListener('change', (e)=> document.body.classList.toggle('light', e.target.checked) );
  document.getElementById('title').textContent = 'RBI Game'; // ensure unchanged

  // ---------- Start ----------
  sessionQuestions = pickSessionQuestions();
  sessionIndex = 0;
  updateStats();
  // show first question quickly
  setTimeout(()=> presentMCQ(), 350);

  // ---------- Error handling ----------
  window.addEventListener('error', (ev)=> console.error('Runtime error:', ev.message, ev.filename, ev.lineno) );

  // ---------- Expose debug helpers ----------
  window.__RBI = { restart: restartGame, stats: ()=> ({economy,bank,publicHappiness,inflation,liquidity,month,sessionIndex}), sessionQuestions };

  // helper: pickSessionQuestions (declared earlier but keep function here to be top-level)
  function pickSessionQuestions(){
    // shuffle pool
    const arr = mcqPool.slice();
    for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
    const pick = arr.slice(0,12);
    // store IDs to prevent exact same in next session ideally
    try{ localStorage.setItem(PREV_SESSION_KEY, JSON.stringify(pick.map(p=>p.id))); }catch(e){}
    return pick;
  }

});
</script>
</body>
</html>
